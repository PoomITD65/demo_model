<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OMR Web Demo</title>
  <style>
    :root{
      --border:#e5e7eb; --muted:#6b7280; --fg:#111; --bg:#fff;
      --brand:#111; --brand-weak:#374151; --ok:#16a34a; --warn:#d97706; --err:#dc2626;
    }
    *{box-sizing:border-box}
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", Arial;
           margin: 24px; color: var(--fg); background: var(--bg);}
    header { margin-bottom: 16px; }
    h1{margin:0 0 8px}
    .muted { color:var(--muted); font-size:13px;}
    .card { border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 2px rgba(0,0,0,.03);}
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .col { flex: 1 1 320px; min-width: 280px; }
    .btn { padding: 10px 14px; border-radius: 10px; border: 1px solid var(--brand); background:var(--brand); color:#fff; cursor:pointer; }
    .btn.secondary{ background:#fff; color:var(--brand); border-color:var(--border); }
    .btn:disabled { opacity:.6; cursor:not-allowed;}
    .label { font-weight:600; margin-right:8px; display:block; margin-bottom:6px; }
    input[type="text"]{ width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; }
    .json { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 13px; background: #f9fafb; padding: 8px; border-radius: 8px; border:1px solid var(--border);}
    .thumb{ max-width:100%; height:auto; border-radius:8px; border:1px solid var(--border);}
    .grid-3{ display:grid; grid-template-columns: repeat(3,minmax(0,1fr)); gap:12px; }
    @media (max-width: 1024px){ .grid-3{ grid-template-columns:1fr; } }
    table { border-collapse: collapse; width: 100%; }
    td,th { border:1px solid var(--border); padding:6px 8px; font-size:14px; text-align:left;}
    th{background:#f8fafc}
    .drop{ border:2px dashed var(--border); border-radius:12px; padding:16px; display:flex; align-items:center; gap:12px; }
    .drop.drag{ border-color:#60a5fa; background:#f0f9ff; }
    .status{ font-size:13px; margin-left:8px;}
    .status.ok{ color:var(--ok); }
    .status.warn{ color:var(--warn); }
    .status.err{ color:var(--err); }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px; color:var(--muted);}
    .imgs img{ max-width:100%; height:auto; border-radius: 8px; border: 1px solid var(--border); background:#fff;}
    .tools{ display:flex; flex-wrap:wrap; gap:8px; align-items:center;}
    .hint{font-size:12px; color:var(--muted); margin-top:4px}
    .kpi{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    .kpi .box{border:1px solid var(--border); border-radius:10px; padding:10px 12px;}
  </style>
</head>
<body>
  <header>
    <h1>üìÑ OMR Web Demo</h1>
    <p class="muted">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ <em>‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ù‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</em> ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô + ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û Debug</p>
  </header>

  <div class="card">
    <div class="row">
      <div class="col">
        <label class="label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
        <div id="drop" class="drop">
          <div>
            <strong>‡∏•‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏°‡∏≤‡∏ß‡∏≤‡∏á</strong> ‡∏´‡∏£‡∏∑‡∏≠ <span class="pill">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</span>
            <div class="hint">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .jpg .png</div>
          </div>
          <input id="file" type="file" accept="image/*" style="display:none" />
        </div>
        <div id="preview-wrap" class="hint" style="margin-top:8px;display:none;">
          <img id="preview" class="thumb" alt="preview"/>
        </div>
      </div>
      <div class="col">
        <label class="label">‡πÄ‡∏â‡∏•‡∏¢ (60 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ A‚ÄìE) <span class="muted">(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</span></label>
        <input id="key" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ABCDEABCDE... (60 ‡∏ï‡∏±‡∏ß)" />
        <div id="keyStatus" class="hint">‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
      </div>
      <div class="col">
        <label class="label">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</label>
        <div class="tools">
          <button id="btn" class="btn">‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</button>
          <button id="copyJson" class="btn secondary" disabled>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON</button>
          <span id="status" class="status"></span>
        </div>
        <div class="hint" style="margin-top:6px">Tip: ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏î‡∏≥‡∏ó‡∏±‡πâ‡∏á 4 ‡∏°‡∏∏‡∏°‡∏ä‡∏±‡∏î ‡πÜ ‡∏à‡∏∞ warp ‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏°‡πà‡∏ô</div>
      </div>
    </div>
  </div>

  <div id="result" style="display:none;">
    <div class="card">
      <div class="kpi">
        <div class="box"><b>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</b><div id="sid" style="font-size:18px">-</div></div>
        <div class="box"><b>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</b><div id="score" style="font-size:18px">-</div></div>
        <div class="box"><b>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠</b><div id="qcount" style="font-size:18px">-</div></div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="card">
          <h3>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</h3>
          <div class="grid-3" id="answers-grid">
            <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á 3 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå -->
          </div>
        </div>
        <div class="card">
          <h3>JSON</h3>
          <div id="json" class="json"></div>
        </div>
      </div>
      <div class="col imgs">
        <div class="card">
          <h3>Warped</h3>
          <img id="img-warped" alt="warped"/>
        </div>
        <div class="card">
          <h3>Binary</h3>
          <img id="img-binary" alt="binary"/>
        </div>
      </div>
      <div class="col imgs">
        <div class="card">
          <h3>Visualize</h3>
          <img id="img-viz" alt="visualize"/>
        </div>
      </div>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);

// ---------- Drag & Drop / Choose ----------
const drop = $("drop");
const fileInput = $("file");

drop.addEventListener("click", () => fileInput.click());
drop.addEventListener("dragover", e => { e.preventDefault(); drop.classList.add("drag"); });
drop.addEventListener("dragleave", () => drop.classList.remove("drag"));
drop.addEventListener("drop", e => {
  e.preventDefault(); drop.classList.remove("drag");
  if (e.dataTransfer.files && e.dataTransfer.files[0]) {
    fileInput.files = e.dataTransfer.files;
    showPreview(fileInput.files[0]);
  }
});
fileInput.addEventListener("change", e => {
  const f = e.target.files[0];
  if (f) showPreview(f);
});

function showPreview(f){
  const url = URL.createObjectURL(f);
  $("preview").src = url;
  $("preview-wrap").style.display = "block";
}

// ---------- Key validator ----------
$("key").addEventListener("input", () => {
  const v = $("key").value.trim().toUpperCase();
  if (!v) { $("keyStatus").innerHTML = "‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô"; $("keyStatus").className="hint"; return; }
  const ok = v.length === 60 && /^[A-E]+$/.test(v);
  $("keyStatus").innerHTML = ok ? "<span class='status ok'>‚úì ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (60 ‡∏ï‡∏±‡∏ß A‚ÄìE)</span>"
                                : "<span class='status warn'>‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡∏ß 60 ‡∏ï‡∏±‡∏ß ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß A‚ÄìE ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>";
});

// ---------- Build answers table (3 columns) ----------
function renderAnswersTables(answers){
  const grid = $("answers-grid");
  grid.innerHTML = "";
  const chunks = [[1,20],[21,40],[41,60]];
  chunks.forEach(([start,end]) => {
    const wrap = document.createElement("div");
    const tbl = document.createElement("table");
    const thead = document.createElement("thead");
    thead.innerHTML = `<tr><th>‡∏Ç‡πâ‡∏≠ ${start}‚Äì${end}</th><th>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</th></tr>`;
    const tbody = document.createElement("tbody");
    for(let q=start; q<=end; q++){
      const tr = document.createElement("tr");
      const ch = answers[String(q)] || "-";
      tr.innerHTML = `<td>${q}</td><td>${ch}</td>`;
      tbody.appendChild(tr);
    }
    tbl.appendChild(thead); tbl.appendChild(tbody);
    wrap.appendChild(tbl);
    grid.appendChild(wrap);
  });
}

// ---------- Copy JSON ----------
$("copyJson").onclick = async () => {
  try{
    await navigator.clipboard.writeText($("json").textContent);
    $("copyJson").textContent = "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úì";
    setTimeout(()=>{$("copyJson").textContent="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON";},1200);
  }catch(e){ alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); }
};

// ---------- Submit ----------
$("btn").onclick = async () => {
  const f = fileInput.files[0];
  if (!f) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"); return; }

  // validate key (optional)
  const key = $("key").value.trim().toUpperCase();
  if (key && (key.length !== 60 || !/^[A-E]+$/.test(key))) {
    alert("‡πÄ‡∏â‡∏•‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡∏ß 60 ‡∏ï‡∏±‡∏ß ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ A‚ÄìE ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
    return;
  }

  $("btn").disabled = true; $("status").textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î/‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";

  const fd = new FormData();
  fd.append("image", f, f.name);
  if (key) fd.append("key", key);

  try {
    const res = await fetch("/api/grade", { method: "POST", body: fd });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");

    // KPI
    $("sid").textContent = data.student_id || "-";
    const sc = data.scoring || {};
    $("score").textContent = (sc && sc.correct != null) ? `${sc.correct}/${sc.total} (${sc.percent}%)` : "-";
    $("qcount").textContent = Object.keys(data.answers || {}).length || "-";

    // Answers (3 columns)
    renderAnswersTables(data.answers || {});

    // Images
    $("img-warped").src = `data:image/png;base64,${data.images.warped_png_base64}`;
    $("img-binary").src = `data:image/png;base64,${data.images.binary_png_base64}`;
    $("img-viz").src = `data:image/png;base64,${data.images.visualize_png_base64}`;

    // JSON
    $("json").textContent = JSON.stringify(data, null, 2);
    $("copyJson").disabled = false;

    $("result").style.display = "block";
    $("status").textContent = "";
  } catch (e) {
    $("status").textContent = "";
    alert(e.message);
  } finally {
    $("btn").disabled = false;
  }
};
</script>
</body>
</html>
